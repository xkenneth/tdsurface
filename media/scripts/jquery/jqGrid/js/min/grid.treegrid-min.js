/*
 * jqGrid extension - Tree Grid
 * Tony Tomov tony@trirand.com
 * http://trirand.com/blog/ 
 */
;(function(b){b.fn.extend({setTreeNode:function(j,h){return this.each(function(){var c=this;if(!c.grid||!c.p.treeGrid){return}var f=0,g=0;if(!c.p.expColInd){for(var i in c.p.colModel){if(c.p.colModel[i].name==c.p.ExpandColumn){f=g;c.p.expColInd=f;break}g++}if(!c.p.expColInd){c.p.expColInd=f}}else{f=c.p.expColInd}var k=c.p.treeReader.expanded_field;var l=c.p.treeReader.leaf_field;var r=c.p.treeReader.level_field;h.level=j[r];if(c.p.treeGridModel=='nested'){h.lft=j[c.p.treeReader.left_field];h.rgt=j[c.p.treeReader.right_field];if(!j[l]){j[l]=(parseInt(h.rgt,10)===parseInt(h.lft,10)+1)?'true':'false'}}else{h.parent_id=j[c.p.treeReader.parent_id_field]}var u=(j[k]&&j[k]=="true")?true:false;var n=parseInt(h.level,10);var o,p;if(c.p.tree_root_level===0){o=n+1;p=n}else{o=n;p=n-1}var q=document.createElement("div");b(q).addClass("tree-wrap").width(o*18);var m=document.createElement("div");b(m).css("left",p*18);q.appendChild(m);if(j[l]=="true"){b(m).addClass("tree-leaf");h.isLeaf=true}else{if(j[k]=="true"){b(m).addClass("tree-minus treeclick");h.expanded=true}else{b(m).addClass("tree-plus treeclick");h.expanded=false}}if(parseInt(j[r],10)!==parseInt(c.p.tree_root_level,10)){if(!b(c).isVisibleNode(h)){b(h).css("display","none")}}var s=b("td:eq("+f+")",h).html();var t=b("td:eq("+f+")",h).html("<span>"+s+"</span>").prepend(q);b(".treeclick",t).click(function(a){var d=a.target||a.srcElement;var e=b(d,c.rows).parents("tr:first")[0].rowIndex;if(!c.rows[e].isLeaf){if(c.rows[e].expanded){b(c).collapseRow(c.rows[e]);b(c).collapseNode(c.rows[e])}else{b(c).expandRow(c.rows[e]);b(c).expandNode(c.rows[e])}}a.stopPropagation()})})},setTreeGrid:function(){return this.each(function(){var a=this;if(!a.p.treeGrid){return}b.extend(a.p,{treeANode:0,treedatatype:null});if(a.p.treeGridModel=='nested'){a.p.treeReader=b.extend({level_field:"level",left_field:"lft",right_field:"rgt",leaf_field:"isLeaf",expanded_field:"expanded"},a.p.treeReader)}else if(a.p.treeGridModel=='adjacency'){a.p.treeReader=b.extend({level_field:"level",parent_id_field:"parent",leaf_field:"isLeaf",expanded_field:"expanded"},a.p.treeReader)}})},expandRow:function(c){this.each(function(){var d=this;if(!d.grid||!d.p.treeGrid){return}var e=b(d).getNodeChildren(c);b(e).each(function(a){b(this).css("display","");if(this.expanded){b(d).expandRow(this)}})})},collapseRow:function(c){this.each(function(){var d=this;if(!d.grid||!d.p.treeGrid){return}var e=b(d).getNodeChildren(c);b(e).each(function(a){b(this).css("display","none");b(d).collapseRow(this)})})},getRootNodes:function(){var f=[];this.each(function(){var d=this;if(!d.grid||!d.p.treeGrid){return}switch(d.p.treeGridModel){case'nested':var e=d.p.treeReader.level_field;b(d.rows).each(function(a){if(parseInt(this[e],10)===parseInt(d.p.tree_root_level,10)){f.push(this)}});break;case'adjacency':var c=d.p.treeReader.parent_id_field;b(d.rows).each(function(a){if(this[c]==null){f.push(this)}});break}});return f},getNodeDepth:function(d){var e=null;this.each(function(){var a=this;if(!this.grid||!this.p.treeGrid){return}switch(a.p.treeGridModel){case'nested':e=parseInt(d.level,10)-parseInt(this.p.tree_root_level,10);break;case'adjacency':e=b(a).getNodeAncestors(d);break}});return e},getNodeParent:function(f){var g=null;this.each(function(){var a=this;if(!a.grid||!a.p.treeGrid){return}switch(a.p.treeGridModel){case'nested':var d=parseInt(f.lft,10),e=parseInt(f.rgt,10),c=parseInt(f.level,10);b(this.rows).each(function(){if(parseInt(this.level,10)===c-1&&parseInt(this.lft)<d&&parseInt(this.rgt)>e){g=this;return false}});break;case'adjacency':b(this.rows).each(function(){if(this.id===f.parent_id){g=this;return false}});break}});return g},getNodeChildren:function(i){var k=[];this.each(function(){var d=this;if(!d.grid||!d.p.treeGrid){return}switch(d.p.treeGridModel){case'nested':var e=parseInt(i.lft,10),c=parseInt(i.rgt,10),f=parseInt(i.level,10);var g=i.rowIndex;b(this.rows).slice(1).each(function(a){if(parseInt(this.level,10)===f+1&&parseInt(this.lft,10)>e&&parseInt(this.rgt,10)<c){k.push(this)}});break;case'adjacency':b(this.rows).slice(1).each(function(a){if(this.parent_id==i.id){k.push(this)}});break}});return k},getNodeAncestors:function(d){var e=[];this.each(function(){if(!this.grid||!this.p.treeGrid){return}var a=b(this).getNodeParent(d);while(a){e.push(a);a=b(this).getNodeParent(a)}});return e},isVisibleNode:function(e){var c=true;this.each(function(){var a=this;if(!a.grid||!a.p.treeGrid){return}var d=b(a).getNodeAncestors(e);b(d).each(function(){c=c&&this.expanded;if(!c){return false}})});return c},isNodeLoaded:function(d){var e;this.each(function(){var a=this;if(!a.grid||!a.p.treeGrid){return}if(d.loaded!==undefined){e=d.loaded}else if(d.isLeaf||b(a).getNodeChildren(d).length>0){e=true}else{e=false}});return e},expandNode:function(a){return this.each(function(){if(!this.grid||!this.p.treeGrid){return}if(!a.expanded){if(b(this).isNodeLoaded(a)){a.expanded=true;b("div.treeclick",a).removeClass("tree-plus").addClass("tree-minus")}else{a.expanded=true;b("div.treeclick",a).removeClass("tree-plus").addClass("tree-minus");this.p.treeANode=a.rowIndex;this.p.datatype=this.p.treedatatype;if(this.p.treeGridModel=='nested'){b(this).setGridParam({postData:{nodeid:a.id,n_left:a.lft,n_right:a.rgt,n_level:a.level}})}else{b(this).setGridParam({postData:{nodeid:a.id,parentid:a.parent_id,n_level:a.level}})}b(this).trigger("reloadGrid");this.treeANode=0;if(this.p.treeGridModel=='nested'){b(this).setGridParam({postData:{nodeid:'',n_left:'',n_right:'',n_level:''}})}else{b(this).setGridParam({postData:{nodeid:'',parentid:'',n_level:''}})}}}})},collapseNode:function(a){return this.each(function(){if(!this.grid||!this.p.treeGrid){return}if(a.expanded){a.expanded=false;b("div.treeclick",a).removeClass("tree-minus").addClass("tree-plus")}})},SortTree:function(l){return this.each(function(){if(!this.grid||!this.p.treeGrid){return}var e,c,f,g=[],i=b(this).getRootNodes();i.sort(function(a,d){if(a.sortKey<d.sortKey){return-l}if(a.sortKey>d.sortKey){return l}return 0});for(e=0,c=i.length;e<c;e++){f=i[e];g.push(f);b(this).collectChildrenSortTree(g,f,l)}var k=this;b.each(g,function(a,d){b('tbody',k.grid.bDiv).append(d);d.sortKey=null})})},collectChildrenSortTree:function(i,k,l){return this.each(function(){if(!this.grid||!this.p.treeGrid){return}var e,c,f,g=b(this).getNodeChildren(k);g.sort(function(a,d){if(a.sortKey<d.sortKey){return-l}if(a.sortKey>d.sortKey){return l}return 0});for(e=0,c=g.length;e<c;e++){f=g[e];i.push(f);b(this).collectChildrenSortTree(i,f,l)}})},setTreeRow:function(d,e){var c,f=false;this.each(function(){var a=this;if(!a.grid||!a.p.treeGrid){return}f=b(a).setRowData(d,e)});return f},delTreeNode:function(f){return this.each(function(){var a=this;if(!a.grid||!a.p.treeGrid){return}var d=b(a).getInd(a.rows,f,true);if(d){var e=b(a).getNodeChildren(d);if(e.length>0){for(var c=0;c<e.length;c++){b(a).delRowData(e[c].id)}}b(a).delRowData(d.id)}})}})})(jQuery);