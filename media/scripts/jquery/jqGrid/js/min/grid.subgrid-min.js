/**
 * jqGrid extension for SubGrid Data
 * Tony Tomov tony@trirand.com
 * http://trirand.com/blog/ 
 */
;(function(b){b.fn.extend({addSubGrid:function(w,x,y,A){return this.each(function(){var a=this;if(!a.grid){return}var r,n,l,o,s;r=document.createElement("td");b(r,w).html("<img src='"+a.p.imgpath+"plus.gif'/>").toggle(function(d){o=b("table:first",a.grid.bDiv).attr("id");n=b(this).parent();var e=y==1?'<td></td>':'';l=b(n).attr("id");s=0;b.each(a.p.colModel,function(c,f){if(this.hidden===true){s++}});var h="<tr class='subgrid'>"+e+"<td><img src='"+a.p.imgpath+"line3.gif'/></td><td colspan='"+parseInt(a.p.colNames.length-1-s)+"'><div id="+o+"_"+l+" class='tablediv'>";b(this).parent().after(h+"</div></td></tr>");b(".tablediv",a).css("width",a.grid.width-20+"px");if(typeof a.p.subGridRowExpanded==='function'){a.p.subGridRowExpanded(o+"_"+l,l)}else{z(n)}b(this).html("<img src='"+a.p.imgpath+"minus.gif'/>").removeClass("sgcollapsed").addClass("sgexpanded")},function(c){if(typeof a.p.subGridRowColapsed==='function'){n=b(this).parent();l=b(n).attr("id");a.p.subGridRowColapsed(o+"_"+l,l)};b(this).parent().next().remove(".subgrid");b(this).html("<img src='"+a.p.imgpath+"plus.gif'/>").removeClass("sgexpanded").addClass("sgcollapsed")}).addClass("sgcollapsed");x.appendChild(r);var z=function(f){var d,e,h;e=b(f).attr("id");h={id:e};if(!a.p.subGridModel[0]){return false}if(a.p.subGridModel[0].params){for(var g=0;g<a.p.subGridModel[0].params.length;g++){for(var k=0;k<a.p.colModel.length;k++){if(a.p.colModel[k].name==a.p.subGridModel[0].params[g]){h[a.p.colModel[k].name]=b("td:eq("+k+")",f).text().replace(/\&nbsp\;/ig,'')}}}}if(!a.grid.hDiv.loading){a.grid.hDiv.loading=true;b("div.loading",a.grid.hDiv).fadeIn("fast");if(!a.p.subgridtype)a.p.subgridtype=a.p.datatype;if(b.isFunction(a.p.subgridtype)){a.p.subgridtype(h)}switch(a.p.subgridtype){case"xml":b.ajax({type:a.p.mtype,url:a.p.subGridUrl,dataType:"xml",data:h,complete:function(c){u(c.responseXML,e)}});break;case"json":b.ajax({type:a.p.mtype,url:a.p.subGridUrl,dataType:"json",data:h,complete:function(c){v(eval("("+c.responseText+")"),e)}});break}}return false};var p=function(c,f,d){var e=document.createElement("div");e.className="celldiv";b(e).html(f);b(e).width(a.p.subGridModel[0].width[d]||80);c.appendChild(e)};var u=function(d,e){var h,g,k="",i,q,j,m=document.createElement("span");h=document.createElement("div");h.className="rowdiv";for(i=0;i<a.p.subGridModel[0].name.length;i++){g=document.createElement("div");g.className="celldivth";b(g).html(a.p.subGridModel[0].name[i]);b(g).width(a.p.subGridModel[0].width[i]);h.appendChild(g)}m.appendChild(h);if(d){j=a.p.xmlReader.subgrid;b(j.root+">"+j.row,d).each(function(){h=document.createElement("div");h.className="rowdiv";if(j.repeatitems===true){b(j.cell,this).each(function(c){p(h,this.textContent||this.text||'&nbsp;',c)})}else{var f=a.p.subGridModel[0].mapping;if(f){for(i=0;i<f.length;i++){p(h,b(f[i],this).text()||'&nbsp;',i)}}}m.appendChild(h)});var t=b("table:first",a.grid.bDiv).attr("id")+"_";b("#"+t+e).append(b(m).html());d=null;a.grid.hDiv.loading=false;b("div.loading",a.grid.hDiv).fadeOut("fast")}return false};var v=function(c,f){var d,e,h="",g,k,i,q=document.createElement("span");d=document.createElement("div");d.className="rowdiv";for(g=0;g<a.p.subGridModel[0].name.length;g++){e=document.createElement("div");e.className="celldivth";b(e).html(a.p.subGridModel[0].name[g]);b(e).width(a.p.subGridModel[0].width[g]);d.appendChild(e)}q.appendChild(d);if(c){i=a.p.jsonReader.subgrid;for(g=0;g<c[i.root].length;g++){k=c[i.root][g];d=document.createElement("div");d.className="rowdiv";if(i.repeatitems===true){if(i.cell){k=k[i.cell]}for(var j=0;j<k.length;j++){p(d,k[j]||'&nbsp;',j)}}else{var m=a.p.subGridModel[0].mapping;if(m.length){for(var j=0;j<m.length;j++){p(d,k[m[j]]||'&nbsp;',j)}}}q.appendChild(d)}var t=b("table:first",a.grid.bDiv).attr("id")+"_";b("#"+t+f).append(b(q).html());c=null;a.grid.hDiv.loading=false;b("div.loading",a.grid.hDiv).fadeOut("fast")}return false};a.subGridXml=function(c,f){u(c,f)};a.subGridJson=function(c,f){v(c,f)}})},expandSubGridRow:function(e){return this.each(function(){var c=this;if(!c.grid&&!e){return}if(c.p.subGrid===true){var f=b(this).getInd(c.rows,e,true);if(f){var d=b("td.sgcollapsed",f)[0];if(d){b(d).trigger("click")}}}})},collapseSubGridRow:function(e){return this.each(function(){var c=this;if(!c.grid&&!e){return}if(c.p.subGrid===true){var f=b(this).getInd(c.rows,e,true);if(f){var d=b("td.sgexpanded",f)[0];if(d){b(d).trigger("click")}}}})},toggleSubGridRow:function(e){return this.each(function(){var c=this;if(!c.grid&&!e){return}if(c.p.subGrid===true){var f=b(this).getInd(c.rows,e,true);if(f){var d=b("td.sgcollapsed",f)[0];if(d){b(d).trigger("click")}else{d=b("td.sgexpanded",f)[0];if(d){b(d).trigger("click")}}}}})}})})(jQuery);